---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SignedIn, SignedOut, UserButton } from '@clerk/astro/components';
import { getCV, getAllFlavors } from '../../lib/cv';

export async function getStaticPaths() {
  const flavors = await getAllFlavors();
  return flavors.map(flavor => ({
    params: { flavor: flavor.data.id },
  }));
}

const { flavor } = Astro.params;
const cvData = await getCV(flavor!);
---

<BaseLayout 
  title={`${cvData.flavor.title} - Godot`}
  description={cvData.flavor.subtitle}
  favicon="/images/favicon_cv.svg"
>
  <Header />
  
  <main class="flex-1 pt-[var(--header-height)]">
    <SignedIn>
      <section class="min-h-screen py-16">
        <div class="container max-w-4xl">
          <!-- User Menu -->
          <div class="flex justify-between items-center mb-8">
            <div class="flex gap-2">
              {(await getAllFlavors()).map(f => (
                <a 
                  href={`/cv/${f.data.id}`}
                  class:list={[
                    "px-3 py-1 text-sm rounded-lg transition-colors",
                    f.data.id === flavor
                      ? "bg-[var(--color-primary)] text-white"
                      : "bg-[var(--color-surface)] text-[var(--color-text-secondary)] hover:bg-[var(--color-surface-elevated)]"
                  ]}
                >
                  {f.data.title}
                </a>
              ))}
            </div>
            <UserButton 
              appearance={{
                elements: {
                  avatarBox: "w-10 h-10"
                }
              }}
            />
          </div>

          <!-- CV Header -->
          <div class="mb-12">
            <h1 class="text-4xl font-bold mb-2 text-gradient">{cvData.flavor.title}</h1>
            <p class="text-xl text-[var(--color-text-secondary)]">{cvData.flavor.subtitle}</p>
          </div>

          <!-- Experience Section -->
          {cvData.experience.length > 0 && (
            <section class="mb-12">
              <h2 class="text-2xl font-semibold mb-6">Experience</h2>
              <div class="space-y-6">
                {cvData.experience.map(exp => (
                  <div class="p-6 bg-[var(--color-surface)] rounded-lg border border-[var(--color-surface-elevated)]">
                    <h3 class="text-xl font-medium text-[var(--color-primary)]">{exp.data.title}</h3>
                    <p class="text-[var(--color-accent)] mb-3">{exp.data.company} • {exp.data.period}</p>
                    <p class="text-[var(--color-text-secondary)] mb-4">{exp.data.description}</p>
                    
                    {exp.data.highlights.length > 0 && (
                      <ul class="space-y-2 mb-4">
                        {exp.data.highlights.map(highlight => (
                          <li class="text-sm text-[var(--color-text-secondary)] flex items-start">
                            <span class="text-[var(--color-primary)] mr-2">▸</span>
                            {highlight}
                          </li>
                        ))}
                      </ul>
                    )}
                    
                    {exp.data.skills && exp.data.skills.length > 0 && (
                      <div class="flex flex-wrap gap-2">
                        {exp.data.skills.map(skill => (
                          <span class="px-2 py-1 text-xs bg-[var(--color-primary-light)] text-[var(--color-primary)] rounded border border-[var(--color-primary)]/30">
                            {skill}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </section>
          )}

          <!-- Skills Section -->
          {cvData.skills.length > 0 && (
            <section class="mb-12">
              <h2 class="text-2xl font-semibold mb-6">Skills</h2>
              <div class="space-y-6">
                {cvData.skills.map(skillCategory => (
                  <div>
                    <h3 class="text-lg font-medium mb-3">{skillCategory.data.category}</h3>
                    <div class="flex flex-wrap gap-3">
                      {skillCategory.data.items.map(skill => (
                        <span class="px-4 py-2 bg-[var(--color-surface)] text-[var(--color-text)] rounded-lg border border-[var(--color-surface-elevated)] hover:border-[var(--color-primary)] transition-colors">
                          {skill.name}
                          {skill.level && (
                            <span class="ml-2 text-xs text-[var(--color-text-muted)]">
                              ({skill.level})
                            </span>
                          )}
                        </span>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}

          <!-- Education Section -->
          {cvData.education.length > 0 && (
            <section class="mb-12">
              <h2 class="text-2xl font-semibold mb-6">Education</h2>
              <div class="space-y-6">
                {cvData.education.map(edu => (
                  <div class="p-6 bg-[var(--color-surface)] rounded-lg border border-[var(--color-surface-elevated)]">
                    <h3 class="text-xl font-medium text-[var(--color-primary)]">{edu.data.degree}</h3>
                    <p class="text-[var(--color-accent)] mb-2">{edu.data.institution} • {edu.data.period}</p>
                    {edu.data.description && (
                      <p class="text-[var(--color-text-secondary)]">{edu.data.description}</p>
                    )}
                  </div>
                ))}
              </div>
            </section>
          )}
        </div>
      </section>
    </SignedIn>

    <SignedOut>
      <section class="min-h-[calc(100vh-var(--header-height))] flex items-center justify-center">
        <div class="text-center">
          <h1 class="text-3xl font-bold mb-4">Authentication Required</h1>
          <p class="text-[var(--color-text-secondary)] mb-6">
            Sign in to view this CV.
          </p>
          <a 
            href="/sign-in"
            class="px-6 py-3 text-base font-medium text-white bg-[var(--color-primary)] rounded-lg hover:bg-[var(--color-primary-hover)] transition-colors duration-[var(--transition-base)] inline-block"
          >
            Sign In
          </a>
        </div>
      </section>
    </SignedOut>
  </main>
  
  <Footer />
</BaseLayout>
